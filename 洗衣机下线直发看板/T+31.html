<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<script type="text/javascript" src="./vue/vue.min.js"></script>
<link rel="stylesheet" href="./element/index.css">
<link rel="stylesheet" href="./testDetails-Css/tThree.css">
<link rel="stylesheet" href="./testDetails-Css/base.css" />
<script src="./element/index.js"></script>

<body>
    <div id="tThree">
        <div class="loading-warehouse-two">
            <div class="loading-warehouse-headline">
                <dl>
                    T+3下线直发提货单投单看板
                </dl>
                <dl>
                    <dd>
                        <img src="./images/logo.png" alt="美的" />
                    </dd>
                    <dd>|</dd>
                    <dd>
                        <span>WMS</span>
                    </dd>
                </dl>
            </div>
            <div class="loading-warehouse-content">
                <span class="border row1"></span>
                <span class="border row2"></span>
                <span class="border col1"></span>
                <span class="border col2"></span>
                <div class="loading-warehouse-head">
                    <div>
                        <dl></dl>
                    </div>
                    <div>
                        <dl>
                            <dd>
                                <i class="el-icon-date"></i>
                            </dd>
                            <dd v-for="(time, index) in timeArr" :key="time+index">{{time}}</dd>
                        </dl>
                    </div>
                </div>
                <div class="data-content">
                    <div class="table-details">
                        <el-table
                            :row-class-name="rowclassname"
                            class="table-forwarding"
                            :data="clallStatisticsData"
                            style="width: 100%; background: #040c31;"
                            ref="tableData"
                            :span-method="arraySpanMethod"
                            height="calc(100vh - 8vw - 37px)"
                        >
                            <el-table-column prop="doNo" label="发车单号" show-overflow-tooltip align="center">
                            </el-table-column>
                            <el-table-column prop="alarmLevel" label="车牌号" show-overflow-tooltip align="center">
                            </el-table-column>
                            <el-table-column prop="area" label="司机电话" show-overflow-tooltip align="center">
                            </el-table-column>
                            <el-table-column prop="alarmTime" label="投单时间" show-overflow-tooltip align="center">
                            </el-table-column>
                            <el-table-column prop="equip" label="总部订单号" show-overflow-tooltip align="center">
                            </el-table-column>
                            <el-table-column prop="site" label="收货地址" show-overflow-tooltip align="center">
                            </el-table-column>
                            <el-table-column prop="alarmValue" label="商品型号" show-overflow-tooltip align="center">
                            </el-table-column>
                            <el-table-column prop="pointName" label="数量" show-overflow-tooltip align="center">
                            </el-table-column>
                        </el-table>
                    </div>
                    <div class="table-bottom">
                        <span>投单20分钟内</span>
                        <span>投单20-30分钟内</span>
                        <span>投单超过30分钟内</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        var demo = new Vue({
            el: '#tThree',
            data: {
                timeArr: [],
                refreshTime: 2 * 60 * 1000,
                cutDateTime: null,
                // 库位
                allStatisticsData: [
                    {
                        doNo: '11111111111',
                        class: 'one',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '11111111111',
                        class: 'one',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '222222222222',
                        class: 'two',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '3333333333333',
                        class: 'three',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '222222222222',
                        class: 'two',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '3333333333333',
                        class: 'three',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '3333333333333',
                        class: 'three',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '11111111111',
                        class: 'one',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '11111111111',
                        class: 'one',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '222222222222',
                        class: 'two',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '3333333333333',
                        class: 'three',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '222222222222',
                        class: 'two',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '3333333333333',
                        class: 'three',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '3333333333333',
                        class: 'three',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '11111111111',
                        class: 'one',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '11111111111',
                        class: 'one',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '222222222222',
                        class: 'two',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '3333333333333',
                        class: 'three',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '222222222222',
                        class: 'two',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '3333333333333',
                        class: 'three',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    },
                    {
                        doNo: '3333333333333',
                        class: 'three',
                        alarmLevel: "粤AA5342",
                        area: "18004166123",
                        equip: "总部2334394844894949",
                        pointName: "35",
                        alarmValue: "TG100v120W@滚筒的豆腐脑了看到发v的绿地",
                        site: '河北省石家庄红旗数据库的烦恼是理库从技术上代理商',
                        alarmTime: "2019-6-1 12:00:00",
                        address1: 'https://segmentfault.com/a/1190000019198505?utm_source=tag-newest'
                    }
                ],
                // 发车单号
                startSingle: '',
                timerDataScroll: null,
                rowLine: [],
                rowLinetwo: [],
                rowLinethree: [],
                clallStatisticsData: []
            },
            methods: {
                // 时间
                parseTime(time, cFormat) {
                    if (arguments.length === 0) {
                        return null;
                    }
                    var date = new Date(time);
                    let fmt = cFormat || 'yyyy-MM-dd hh:mm:ss';
                    var o = {
                        'M+': date.getMonth() + 1, // 月份
                        'd+': date.getDate(), // 日
                        'h+': date.getHours(), // 小时
                        'm+': date.getMinutes(), // 分
                        's+': date.getSeconds(), // 秒
                        'q+': Math.floor((date.getMonth() + 3) / 3) // 季度
                    };
                    if (/(y+)/.test(fmt)) {
                        fmt = fmt.replace(RegExp.$1, (date.getFullYear() + '').substr(4 - RegExp.$1.length));
                    }
                    Object.keys(o).forEach(k => {
                        if (new RegExp('(' + k + ')').test(fmt)) {
                            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (('00' + o[k]).substr(('' + o[k]).length)));
                        }
                    });
                    return fmt;
                },
                getNowFormatDate(data, pattern) {
                    // 格式化时间和拿到当前星期几
                    var dataTime = data || new Date();
                    var time = this.parseTime(dataTime);
                    return [
                        time,
                        '星期' + '日一二三四五六'.charAt(new Date().getDay())
                    ];
                },
                cutDate() {
                    var dataArr = this.getNowFormatDate('', 'YYYY-MM-DD HH:mm:ss');
                    var [data, timer] = dataArr[0].split(' ');
                    var week = dataArr[1];
                    this.timeArr = [data, week, timer];
                },
                refreshData(fn, timeInterval, timeName) {
                    this[fn]();
                    this[timeName] = window.setTimeout(() => {
                        this.refreshData(fn, timeInterval, timeName);
                    }, timeInterval);
                },
                // 搜索发车单号
                searchChange() {
                    if (this.timerDataScroll) {
                        window.clearTimeout(this.timerDataScroll);
                    };
                    var self = this;
                    // $.sns.ajax({
                    //     url: $.sns.modulePath + '/compoments/appsupport/commonQuery.shtml?_queryType=WmSoHeaderInvQuery&shipNo=' + this.startSingle,
                    //     dataType: "json",
                    //     success: function (result) {
                            // if (result.code == 0) {
                            //     self.allStatisticsData = [];
                            //     self.allStatisticsData = result.data.data
                            // }
                            // 合并
                            var allSiteName = [];
                            var tableData = [];
                            self.allStatisticsData.map(item => {
                                var doNoIndex = allSiteName.indexOf(item.doNo);
                                if (doNoIndex > -1) {
                                    tableData[doNoIndex].push(item);
                                } else {
                                    allSiteName.push(item.doNo);
                                    var arr = [item];
                                    tableData[tableData.length] = arr;
                                }
                            })
                            // 获取发车单号合并
                            tableData.map((item, index) => {
                                let arr = [];
                                if (index > 0) {
                                    arr = [
                                        self.rowLine[index - 1][0] + self.rowLine[index - 1][1],
                                        item.length
                                    ];
                                } else {
                                    arr = [0, item.length];
                                }
                                self.rowLine[self.rowLine.length] = arr;
                            })
                            // 车型的合并
                            var AllprovinceData = [];
                            tableData.map((item, index) => {
                                let provinceName = [];
                                let provinceData = [];
                                item.map(xh => {
                                    var provinceIndex = provinceName.indexOf(xh.alarmLevel);
                                    if (provinceIndex > -1) {
                                        provinceData[provinceIndex].push(xh);
                                    } else {
                                        provinceName.push(xh.alarmLevel);
                                        var arr1 = [xh];
                                        provinceData[provinceData.length] = arr1;
                                    }
                                })
                                provinceData.map(item => {
                                    AllprovinceData.push(item)
                                })
                            })
                            AllprovinceData.map((itemtwo, value) => {
                                let arr = [];
                                if (value > 0) {
                                    arr = [
                                        self.rowLinetwo[value - 1][0] + self.rowLinetwo[value - 1][1],
                                        itemtwo.length
                                    ];
                                } else {
                                    arr = [0, itemtwo.length];
                                }
                                self.rowLinetwo[self.rowLinetwo.length] = arr;

                            })
                            this.clallStatisticsData = []
                            // 合计的合并
                            var AlladdressData = [];
                            tableData.map((item, index) => {
                                let addressName = [];
                                let addressData = [];
                                item.map(xh => {
                                    var addressIndex = addressName.indexOf(xh.area);
                                    if (addressIndex > -1) {
                                        addressData[addressIndex].push(xh);
                                    } else {
                                        addressName.push(xh.area);
                                        var arr1 = [xh];
                                        addressData[addressData.length] = arr1;
                                    }
                                })
                                addressData.map(item => {
                                    AlladdressData.push(item)
                                })
                            })
                            AlladdressData.map((itemthree, value) => {
                                let arr = [];
                                if (value > 0) {
                                    arr = [
                                        self.rowLinethree[value - 1][0] + self.rowLinethree[value - 1][1],
                                        itemthree.length
                                    ];
                                } else {
                                    arr = [0, itemthree.length];
                                }
                                self.rowLinethree[self.rowLinethree.length] = arr;
                            })
                        // }
                    // });
                    tableData.map(item => {
                        item.map(item1 => {
                            this.clallStatisticsData.push(item1)
                        })
                    })
                    this.$nextTick(() => {
                        this.dom = this.$refs.tableData.bodyWrapper;
                        this.dom.scrollTop = 0;
                        this.dataScroll(this.dom, 50);
                    });
                },
                // dom 
                dataScroll(dom, millisecond) {
                    if (dom.scrollTop + dom.clientHeight >= dom.scrollHeight) {
                        dom.scrollTop = 0;
                    }
                    dom.scrollTop += 1;
                    this.timerDataScroll = window.setTimeout(() => {
                        this.dataScroll(dom, millisecond);
                    }, millisecond);
                },
                // 合并列
                arraySpanMethod({ row, column, rowIndex, columnIndex }) {
                    const arr = this.rowLine.filter(item => item[1] !== 1);
                    const arr1 = this.rowLinetwo.filter(item => item[1] !== 1);
                    const arr2 = this.rowLinethree.filter(item => item[1] !== 1);
                    let rowMerge = [1, 1];
                    arr.some(item => {
                        if (rowIndex === item[0]) {
                            if (columnIndex === 0) {
                                rowMerge = [item[1], 1];
                            }
                        } else if (columnIndex === 0 && rowIndex > item[0] && rowIndex < item[0] + item[1]) {
                            rowMerge = [0, 0];
                        }
                    });
                    arr1.some(item => {
                        if (rowIndex === item[0]) {
                            if (columnIndex === 1) {
                                rowMerge = [item[1], 1];
                            }
                        } else if (columnIndex === 1 && rowIndex > item[0] && rowIndex < item[0] + item[1]) {
                            rowMerge = [0, 0];
                        }
                    });
                    arr2.some(item => {
                        if (rowIndex === item[0]) {
                            if (columnIndex === 2) {
                                rowMerge = [item[1], 1];
                            }
                        } else if (columnIndex === 2 && rowIndex > item[0] && rowIndex < item[0] + item[1]) {
                            rowMerge = [0, 0];
                        }
                    });
                    return rowMerge;
                },
                rowclassname(row) {
                    if (row.row.class === 'one') {
                        return "twenty-row";
                    } else if (row.row.class === 'two') {
                        return "twentythirty-row";
                    } else if (row.row.class === 'three') {
                        return "exceedthirty-row";
                    }
                },
            },
            mounted() {
                this.refreshData('cutDate', 1000, 'cutDateTime');
                this.refreshData('searchChange', this.refreshTime, 'getDataTime');
            },
            beforeDestroy() {
                if (this.timerDataScroll) {
                    window.clearTimeout(this.timerDataScroll);
                    this.timerDataScroll = null;
                }
                window.clearTimeout(this.cutDateTime);
                window.clearTimeout(this.getDataTime);
            }
        })

    </script>
</body>

</html>